<!-- cd39f542-0d74-4313-b4a2-e52a4c840844 34f74513-660d-4887-b3fb-93a91ab56f9c -->
# Cross-Platform Screen Mirroring Plan

## Quick Summary & Stack

- Acting as the senior React Native architect, deliver a bare RN app with native capture modules, WebRTC streaming, Chromecast casting, and ReplayKit extension support. Backend relies on lightweight Node.js + Socket.IO signaling, optional TURN, and Firebase/Auth for persistence when needed.
- Recommended stack: React Native CLI, TypeScript, react-navigation, Zustand/Redux for state, AsyncStorage + optional Firebase, WebRTC for P2P, Google Cast for Chromecast devices.

## Architecture Overview

- **Project structure**: `src/screens` (AuthScreen, HomeScreen, DeviceDiscoveryScreen, etc.), `src/components` (MirrorControlsOverlay, DeviceCard, CastTargetList), `src/modules` (AndroidCaptureModule, ReplayKitBridge, CastBridge), `src/data` (model definitions, mappers, fixtures), `src/state` (Zustand/Redux stores), `src/services` (signaling, REST, analytics), `src/utils` (formatters, quality heuristics). Add `src/theme` to centralize color palette/typography extracted from the provided auth design prompt. Index barrels per folder keep imports clean.
- **Mobile layers**: UI (React Navigation stacks), capture service (native modules bridging MediaProjection/ReplayKit), streaming engine (react-native-webrtc), cast bridge (react-native-google-cast), data/state (Zustand/Redux), persistence (AsyncStorage/Firebase).
- **Backend**: Node.js + Socket.IO server for room management & SDP/ICE exchange; REST endpoints for auth/history; optional Firebase Cloud Functions if using Firebase.
- **Data flow**: User authenticates → selects device/session → capture module provides frames/audio → WebRTC peer connection sends to receiver/Chromecast via WebRTC or Cast channel → history persists locally/cloud → signaling keeps session state.

## Screens & UX Flows

- **Auth Screen**: Email/password, social login buttons, guest toggle, biometric prompt if available.
- **Home Dashboard**: Recent sessions list, quick "Start Mirroring" CTA, connected status indicator, quality profile selector.
- **Device Discovery**: Tabs for Nearby Devices (mDNS/DNS-SD + Google Cast scan), Rooms (enter code/QR), Saved Devices; show device card with name, type, last seen.
- **Mirror Controls Overlay**: Floating overlay on sender view with Start/Stop, pause, audio toggle, bitrate/resolution slider, Chromecast target switcher, network indicator.
- **Receiver View**: Fullscreen video, latency indicator, "Close Mirror" button, optional chat/instructions.
- **History Screen**: List of sessions with date, duration, device, method (WebRTC/Cast). Swipe to delete, tap to retry.
- **Settings Screen**: Profile, login status, privacy toggles (include system dialogs), TURN server config, playback defaults, diagnostics log export.

## Data Models

```json
Device: {
  id: string,
  name: string,
  type: 'android' | 'ios' | 'tv' | 'chromecast',
  lastSeenAt: string,
  capabilities: { cast:boolean, webrtc:boolean },
  metadata?: Record<string, any>
}
Session: {
  id: string,
  senderId: string,
  receiverId: string,
  startTs: string,
  endTs: string | null,
  method: 'webrtc' | 'chromecast',
  resolution: string,
  bitrateKbps: number,
  turnUsed: boolean,
  events: Array<{ ts:string, type:string, payload?:any }>
}
User: {
  id: string,
  email?: string,
  displayName?: string,
  authProvider: 'guest' | 'email' | 'google' | 'apple',
  avatarUrl?: string,
  preferences: {
    defaultQuality: string,
    autoStartCast: boolean,
    saveHistory: boolean
  }
}
```

## Important Libraries & Commands

- `react-native-webrtc`: WebRTC capture/streaming bridge. Install: `npm install react-native-webrtc` + `cd ios && pod install`.
- `react-native-google-cast`: Chromecast discovery & casting. Install: `npm install react-native-google-cast` + `cd ios && pod install`.
- `@react-navigation/native`, `@react-navigation/native-stack`, `react-native-screens`, `react-native-safe-area-context`: navigation scaffolding. Install commands per requirement.
- `socket.io-client`: signaling client. `npm install socket.io-client`.
- `axios`: REST calls. `npm install axios`.
- `@react-native-async-storage/async-storage`: local persistence. `npm install @react-native-async-storage/async-storage`.
- `react-native-device-info`: device metadata. `npm install react-native-device-info`.
- Optional `react-native-record-screen`: fallback capturing small views. `npm install react-native-record-screen`.

## Platform-Specific Notes

- **Android**:
  - Request `MediaProjection` via `MediaProjectionManager.createScreenCaptureIntent`; handle activity result inside native module. Store virtual display + ImageReader for frames.
  - Use a foreground service (`ForegroundService`) with persistent notification to keep capture running; tie lifecycle to RN headless JS for control events.
  - Permissions: `RECORD_AUDIO`, `FOREGROUND_SERVICE`, `SYSTEM_ALERT_WINDOW` if overlay needed. Manifest must declare service, receiver, and `<uses-feature android:name="android.software.leanback" android:required="false" />` if targeting TVs.
  - Handle Doze/battery optimizations, request `REQUEST_IGNORE_BATTERY_OPTIMIZATIONS` when necessary.
- **iOS**:
  - ReplayKit `RPScreenRecorder` for in-app capture (iOS 12+). For full device screen mirror, build Broadcast Upload Extension (`RPBroadcastSampleHandler`) sending CMSampleBuffers through shared app group to WebRTC.
  - Extension packaging: separate target, ensure `react-native-webrtc` configured to accept frames from extension via shared sockets or app group file.
  - Info.plist: `NSMicrophoneUsageDescription`, `NSCameraUsageDescription`, ReplayKit usage strings. Provide privacy purpose strings referencing screen capture.
  - Follow App Store privacy: show overlay or toast reminding capture active, provide in-app stop button, respect ReplayKit indicator.

## Signaling & TURN Guidance

- **Server**: Node.js + Express + Socket.IO; maintain rooms keyed by sessionId; store pending offers/answers and ICE candidates.
- **TURN**: Use coturn when peers behind symmetric NAT or corporate firewalls. Deploy on cloud VM with TLS; configure `iceServers` with STUN fallback. Monitor TURN usage metrics.
```js
// server/index.js
io.on('connection', socket => {
  socket.on('join-session', ({ sessionId, role }) => {
    socket.join(sessionId);
    socket.to(sessionId).emit('peer-joined', { socketId: socket.id, role });
  });
  socket.on('signal', payload => {
    socket.to(payload.sessionId).emit('signal', payload);
  });
  socket.on('disconnect', () => {/* clean up */});
});
```


## Persistence & Auth Options

- **Guest/Local**: Use AsyncStorage to keep recent devices, sessions, preferences. Provide optional PIN-based local auth.
- **Cloud**: Firebase Auth (email/social) + Firestore for sync of `Device`/`Session`. Alternatively custom backend with JWT + Postgres.
- Sync strategy: optimistic updates locally, background sync when network available. Encrypt sensitive metadata if storing on device.

## Dev Milestones & Sprint Checklist

1. **Sprint 0**: Initialize RN project, set up TypeScript, navigation, theme, lint/test tooling; verify folder scaffolding under `src/` matches structure; run `npm run lint && npm run test`, then `git add . && git commit -m "chore: bootstrap project" && git push`.
2. **Sprint 1**: Implement auth flows (guest + email), scaffolding screens, AsyncStorage caching; ensure CI green, smoke test login, then commit/push.
3. **Sprint 2**: Build Node/Socket.IO signaling server + RN socket client; create basic WebRTC P2P sender/receiver with dummy video; confirm no blocking bugs before committing/pushing.
4. **Sprint 3**: Integrate Android MediaProjection & iOS ReplayKit; expose start/stop capture in RN via native modules; regression test capture, then commit/push.
5. **Sprint 4**: Chromecast integration; device discovery UI, casting controls; run end-to-end cast tests, then commit/push.
6. **Sprint 5**: Add TURN/coturn, connection quality controls, reliability enhancements, logging; validate under adverse networks, then commit/push.
7. **Sprint 6**: Persistence sync (Firebase/REST), history screen, diagnostics; ensure migration scripts/tests pass, then commit/push.
8. **Sprint 7**: QA, performance tuning, battery/thermal profiling, App Store/Play Store prep; only after bug bash passes, run final commit/push before release candidate tag.

## Testing Matrix

- **Devices**: Pixel 6/7, Samsung S21/S22, OnePlus, iPhone 12/13/14, iPad (ReplayKit), Chromecast Ultra/with Google TV, Android TV.
- **OS versions**: Android 11–15, iOS 15–18.
- **Networks**: Wi-Fi 2.4/5GHz, cellular 4G/5G, captive portal, VPN. Test with high latency (simulate with Network Link Conditioner) and packet loss.
- **Scenarios**: Backgrounding while mirroring, incoming call, rotation, screen recording indicator, audio-only, Cast fallback.

## Known Caveats & Tradeoffs

- Low-latency mirroring vs battery/CPU usage; need dynamic bitrate/resolution adjustments.
- ReplayKit broadcast extension cannot capture DRM-protected content; communicate limitation.
- Chromecast path mirrors via Google’s cast channel, not WebRTC; feature parity differs.
- TURN servers add cost but required for enterprise networks.
- App Store review scrutiny for screen recording; ensure user consent and indicator compliance.

## Minimal POC Snippets

```ts
// RN capture trigger
const startCapture = async () => {
  const granted = await NativeModules.ScreenCapture.request_permission();
  if (granted) NativeModules.ScreenCapture.start({ audio: true, resolution: '720p' });
};
```
```ts
// Socket signaling
socket.emit('join-session', { sessionId, role: 'sender' });
socket.on('signal', payload => handleSignal(payload));
const sendOffer = offer => socket.emit('signal', { sessionId, type: 'offer', sdp: offer.sdp });
```
```ts
// Add tracks to RTCPeerConnection
const pc = new RTCPeerConnection({ iceServers });
const stream = await mediaStreamPromise; // from native capture
stream.getTracks().forEach(track => pc.addTrack(track, stream));
```

## Release Readiness Checklist

- Capture modules stable on Android/iOS; ReplayKit extension signed + embedded; `src/` folders documented.
- TURN servers configured, monitored, credentials rotated.
- Privacy disclosures & consent screens verified; store metadata encrypted.
- Store assets, screenshots, and descriptions ready; QA matrix passed; crash-free metrics acceptable.
- Automations: CI for lint/test/build, beta distribution via TestFlight/Internal Testing.
- Final step: run regression suite, then `git status` (ensure clean), `git add .`, `git commit -m "release: candidate build"`, `git push origin main` before tagging.

## Required JSON

{"projectName":"MirrorApp","platforms":["android","ios"],"stack":{"mobile":"react-native","streaming":"react-native-webrtc","cast":"react-native-google-cast","signaling":"node/socket.io","storage":"AsyncStorage | Firebase optional"},"coreLibraries":[{"name":"react-native-webrtc","reason":"WebRTC support for P2P streaming","install":"npm install react-native-webrtc"},{"name":"react-native-google-cast","reason":"Chromecast discovery & cast control","install":"npm install react-native-google-cast"},{"name":"@react-navigation/native","reason":"Screen navigation","install":"npm install @react-navigation/native @react-navigation/native-stack react-native-screens react-native-safe-area-context"},{"name":"socket.io-client","reason":"Signaling client","install":"npm install socket.io-client"},{"name":"axios","reason":"API calls","install":"npm install axios"},{"name":"@react-native-async-storage/async-storage","reason":"Local persistence for history","install":"npm install @react-native-async-storage/async-storage"}],"features":["Auth (email + optional OAuth)","Sender (screen capture with audio toggle, start/stop)","Receiver (join room or QR, play stream)","Chromecast support","List of previous connected devices with reconnect","Close Mirror button","Quality control (resolution/bitrate)","Local history with optional cloud sync"],"milestones":["Init project & base screens","WebRTC signaling & POC sender/receiver","Chromecast integration","Add TURN/coturn if needed","Auth & persistent history","Testing & app store release"],"commands":["npx react-native init MirrorApp","cd MirrorApp","npm install react-native-webrtc react-native-google-cast @react-navigation/native socket.io-client axios @react-native-async-storage/async-storage","cd ios && pod install"],"dataModels":{"Device":"{ id:string, name:string, type:string, lastSeenAt:string, metadata:object }","Session":"{ id:string, senderId:string, receiverId:string, startedAt:string, endedAt:string|null, method:string, resolution:string, bitrateKbps:number }","User":"{ id:string, email:string, displayName:string }"},"platformNotes":{"android":"Use MediaProjection for screen capture and implement a foreground service for long-running capture; request RECORD_AUDIO at runtime; update manifest for service and permissions.","ios":"Use ReplayKit + Broadcast Upload Extension for full screen capture; implement user consent flows and follow App Store privacy guidelines; simulators are insufficient for testing."},"notes":"Use expo-dev-client or bare RN workflow because native modules are required; always test on real devices and provide clear privacy UI when capturing screen/audio."}

### To-dos

- [ ] 